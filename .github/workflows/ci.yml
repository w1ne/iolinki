name: iolinki CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  docker-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      
      - uses: actions/checkout@v4

      - name: Fix Permissions and Cleanup
        run: |
          sudo chmod -R 777 .
          sudo rm -rf build build_docker build_bare build_quality

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Zephyr Base Image
        id: cache-zephyr
        uses: actions/cache@v4
        with:
          path: zephyr-base-image.tar
          key: ${{ runner.os }}-zephyr-base-3.5.0

      - name: Load Zephyr Base Image
        if: steps.cache-zephyr.outputs.cache-hit == 'true'
        run: docker load -i zephyr-base-image.tar

      - name: Run All Tests in Docker
        run: |
          chmod +x run_all_tests_docker.sh
          ./run_all_tests_docker.sh

      - name: Save Zephyr Base Image for Cache
        if: steps.cache-zephyr.outputs.cache-hit != 'true'
        run: |
          docker save iolinki-zephyr-base > zephyr-base-image.tar
