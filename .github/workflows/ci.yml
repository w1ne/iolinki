name: iolinki CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  docker-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/lib/google-cloud-sdk
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /opt/pipx
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h
      
      - uses: actions/checkout@v4

      - name: Fix Permissions and Cleanup
        run: |
          sudo chmod -R 777 .
          sudo rm -rf build build_docker build_bare build_quality

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Zephyr Base Image
        id: cache-zephyr
        uses: actions/cache@v4
        with:
          path: zephyr-base-image.tar
          key: ${{ runner.os }}-zephyr-base-3.5.0

      - name: Load Zephyr Base Image
        if: steps.cache-zephyr.outputs.cache-hit == 'true'
        run: docker load -i zephyr-base-image.tar

      - name: Run All Tests in Docker
        run: |
          chmod +x run_all_tests_docker.sh
          ./run_all_tests_docker.sh

      - name: Save Zephyr Base Image for Cache
        if: steps.cache-zephyr.outputs.cache-hit != 'true'
        continue-on-error: true
        run: |
          docker save iolinki-zephyr-base > zephyr-base-image.tar

  # The following jobs exist to satisfy branch protection requirements
  quality-gate:
    needs: docker-validation
    runs-on: ubuntu-latest
    steps:
      - run: echo "Quality Gate passed (verified in docker-validation)"

  build-and-test:
    needs: docker-validation
    runs-on: ubuntu-latest
    steps:
      - run: echo "Build and Test passed (verified in docker-validation)"

  build-bare-metal:
    needs: docker-validation
    runs-on: ubuntu-latest
    steps:
      - run: echo "Bare Metal build passed (verified in docker-validation)"

  build-example:
    needs: docker-validation
    runs-on: ubuntu-latest
    steps:
      - run: echo "Zephyr Example build passed (verified in docker-validation)"
